local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local Debris = game:GetService("Debris")

-- GUI setup
local ScreenGui = Instance.new("ScreenGui", PlayerGui)
ScreenGui.Name = "DupeToolGui"
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 250, 0, 180)
MainFrame.Position = UDim2.new(0.5, -125, 0.5, -90)
MainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
MainFrame.BorderSizePixel = 2
MainFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
MainFrame.Active = true
MainFrame.Draggable = true

local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
Title.Text = "DUPLICATOR"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18

local SelectedLabel = Instance.new("TextLabel", MainFrame)
SelectedLabel.Size = UDim2.new(1, 0, 0, 20)
SelectedLabel.Position = UDim2.new(0, 0, 0, 30)
SelectedLabel.BackgroundTransparency = 1
SelectedLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
SelectedLabel.Font = Enum.Font.SourceSansBold
SelectedLabel.TextSize = 14
SelectedLabel.Text = "Selected: None"

local ChooseBtn = Instance.new("TextButton", MainFrame)
ChooseBtn.Size = UDim2.new(0.8, 0, 0, 30)
ChooseBtn.Position = UDim2.new(0.1, 0, 0, 50)
ChooseBtn.Text = "Choose Item"
ChooseBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 200)
ChooseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ChooseBtn.Font = Enum.Font.SourceSansBold
ChooseBtn.TextSize = 16

local DupeBtn = Instance.new("TextButton", MainFrame)
DupeBtn.Size = UDim2.new(0.8, 0, 0, 40)
DupeBtn.Position = UDim2.new(0.1, 0, 0, 120)
DupeBtn.Text = "Duplicate"
DupeBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
DupeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
DupeBtn.Font = Enum.Font.SourceSansBold
DupeBtn.TextSize = 18

local CloseBtn = Instance.new("TextButton", MainFrame)
CloseBtn.Size = UDim2.new(0, 20, 0, 20)
CloseBtn.Position = UDim2.new(1, -25, 0, 5)
CloseBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.Font = Enum.Font.SourceSansBold
CloseBtn.TextSize = 14
CloseBtn.MouseButton1Click:Connect(function()
	ScreenGui:Destroy()
end)

-- Variables
local selectedItem = nil

-- âœ… Fixed: Animation Copy & Play
local function copyAnimationsAndPlay(original, clone)
	local origAnimator = original:FindFirstDescendantWhichIsA("Animator")
	if not origAnimator then return end

	local animTracks = {}
	for _, track in ipairs(origAnimator:GetPlayingAnimationTracks()) do
		if track.Animation then
			table.insert(animTracks, {
				AnimationId = track.Animation.AnimationId,
				Looped = track.Looped
			})
		end
	end

	local cloneAnimator = clone:FindFirstDescendantWhichIsA("Animator")
	if not cloneAnimator then
		local hum = clone:FindFirstChildOfClass("Humanoid")
		if not hum then
			hum = Instance.new("Humanoid")
			hum.Parent = clone
		end
		cloneAnimator = hum:FindFirstChildOfClass("Animator") or Instance.new("Animator", hum)
	end

	for _, animData in ipairs(animTracks) do
		local newAnim = Instance.new("Animation")
		newAnim.AnimationId = animData.AnimationId
		local track = cloneAnimator:LoadAnimation(newAnim)
		track.Looped = animData.Looped
		track:Play()
	end
end

-- Duplicate Logic
DupeBtn.MouseButton1Click:Connect(function()
	if not selectedItem or not selectedItem:IsDescendantOf(Player.Backpack) then
		local warn = Instance.new("TextLabel", MainFrame)
		warn.Size = UDim2.new(1, 0, 0, 20)
		warn.Position = UDim2.new(0, 0, 0, 160)
		warn.BackgroundTransparency = 1
		warn.TextColor3 = Color3.new(1, 0, 0)
		warn.Font = Enum.Font.SourceSans
		warn.TextSize = 14
		warn.Text = "No item selected!"
		Debris:AddItem(warn, 2)
		return
	end

	local clone = selectedItem:Clone()
	clone.Parent = Player.Backpack

	task.wait(0.1)
	copyAnimationsAndPlay(selectedItem, clone)

	local notify = Instance.new("TextLabel", MainFrame)
	notify.Size = UDim2.new(1, 0, 0, 20)
	notify.Position = UDim2.new(0, 0, 0, 160)
	notify.BackgroundTransparency = 1
	notify.TextColor3 = Color3.new(0, 1, 0)
	notify.Font = Enum.Font.SourceSans
	notify.TextSize = 14
	notify.Text = "Duplicated: " .. selectedItem.Name
	Debris:AddItem(notify, 2)
end)

-- Choose Item Logic
ChooseBtn.MouseButton1Click:Connect(function()
	if MainFrame:FindFirstChild("SelectorFrame") then return end

	local frame = Instance.new("Frame", MainFrame)
	frame.Name = "SelectorFrame"
	frame.Size = UDim2.new(0, 220, 0, 230)
	frame.Position = UDim2.new(0.5, -110, 0.5, -115)
	frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
	frame.BorderSizePixel = 2
	frame.BorderColor3 = Color3.new(1,1,1)

	local close = Instance.new("TextButton", frame)
	close.Size = UDim2.new(0, 20, 0, 20)
	close.Position = UDim2.new(1, -25, 0, 5)
	close.Text = "X"
	close.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
	close.TextColor3 = Color3.fromRGB(255,255,255)
	close.Font = Enum.Font.SourceSansBold
	close.TextSize = 14
	close.MouseButton1Click:Connect(function()
		frame:Destroy()
	end)

	local search = Instance.new("TextBox", frame)
	search.Size = UDim2.new(1, -10, 0, 25)
	search.Position = UDim2.new(0, 5, 0, 25)
	search.PlaceholderText = "Search..."
	search.Text = ""
	search.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
	search.TextColor3 = Color3.fromRGB(255,255,255)
	search.Font = Enum.Font.SourceSans
	search.TextSize = 16

	local scroll = Instance.new("ScrollingFrame", frame)
	scroll.Size = UDim2.new(1, -10, 1, -60)
	scroll.Position = UDim2.new(0, 5, 0, 55)
	scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
	scroll.ScrollBarThickness = 6
	scroll.BackgroundColor3 = Color3.fromRGB(50, 50, 50)

	local list = Instance.new("UIListLayout", scroll)
	list.Padding = UDim.new(0, 5)
	list:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
		scroll.CanvasSize = UDim2.new(0, 0, 0, list.AbsoluteContentSize.Y)
	end)

	local function updateItems(filter)
		for _, child in ipairs(scroll:GetChildren()) do
			if child:IsA("TextButton") then child:Destroy() end
		end

		for _, tool in ipairs(Player.Backpack:GetChildren()) do
			if not filter or tool.Name:lower():find(filter:lower()) then
				local btn = Instance.new("TextButton", scroll)
				btn.Size = UDim2.new(1, 0, 0, 30)
				btn.Text = tool.Name
				btn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
				btn.TextColor3 = Color3.fromRGB(255, 255, 255)
				btn.Font = Enum.Font.SourceSans
				btn.TextSize = 16

				btn.MouseButton1Click:Connect(function()
					selectedItem = tool
					SelectedLabel.Text = "Selected: " .. tool.Name
					frame:Destroy()
				end)
			end
		end
	end

	search:GetPropertyChangedSignal("Text"):Connect(function()
		updateItems(search.Text)
	end)

	updateItems("")
end)
